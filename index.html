<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login with Your Panda Wallet</title>
</head>
<body>
    <h1>Login with Your Panda Wallet</h1>
    <button id="loginWithWallet">Login with Wallet</button>

    <script>
        const COLLECTION_IDS = {
            "Grand Tardinians": "f099182e168c0a30a9f97556d156c8b6284cfc3f76eca8352807b1ceff29da04_0",
            "Order of the Delta": "217c6fa01e2d59e04138e117198635f750685aca771d1d3e5c808e4bf694df78_0",
            "0Face": "cc274a2cc28d88f24a7442443b5542fefe95e486f81f4261e0649401eec30c5d_0",
        };

        const DISCORD_ROLE_IDS = {
            "Grand Tardinians": "1236737036455641129",
            "Order of the Delta": "1236737424445669408",
            "0Face": "1236737537863581716",
            "Unnamed Collection": "1236737616490139788"
        };

        const initProvider = () => {
            console.log("Initializing Panda Wallet provider...");
            if ('panda' in window) {
                const provider = window.panda;
                if (provider.isReady) {
                    console.log("Panda Wallet provider is ready.");
                    return provider;
                }
            }
            alert('Panda Wallet extension is not detected. Please ensure it is installed and enabled.');
            window.open('https://chromewebstore.google.com/detail/panda-wallet/mlbnicldlpdimbjdcncnklfempedeipj', '_blank');
            return null;
        };

        const loginWithPandaWallet = async () => {
            console.log("Attempting to log in with Panda Wallet...");
            try {
                const wallet = initProvider();
                if (!wallet) return;

                console.log("Connecting to Panda Wallet...");
                const accounts = await wallet.connect();
                if (accounts.length === 0) {
                    alert('No accounts found. Please ensure your Panda Wallet is unlocked.');
                    return;
                }

                const account = accounts[0];
                console.log('Logged in with Account:', account);

                const { ordAddress } = await wallet.getAddresses();
                console.log('Logged in with Ordinals Address:', ordAddress);

                // Check the user's ordinals
                await checkUserOrdinals(ordAddress, account);

            } catch (err) {
                console.error('Error when interacting with Panda Wallet:', err);
                alert('Failed to login with Panda Wallet. Please ensure it is unlocked and try again.');
            }
        };

        const checkUserOrdinals = async (ordAddress, account) => {
            console.log("Checking user's ordinals for address:", ordAddress);
            try {
                const userCollections = [];

                for (const [name, collectionId] of Object.entries(COLLECTION_IDS)) {
                    console.log(`Fetching holders for collection: ${name}, ID: ${collectionId}`);
                    const response = await fetch(`https://ordinals.gorillapool.io/api/collections/${collectionId}/holders`);
                    const holders = await response.json();
                    console.log(`Fetched ${holders.length} holders for collection: ${name}`);

                    if (holders.some(holder => holder.address === ordAddress)) {
                        console.log(`User has access to collection: ${name}`);
                        userCollections.push(name);
                    } else {
                        console.log(`User does not have access to collection: ${name}`);
                    }
                }

                if (userCollections.length > 0) {
                    alert(`User has access to the following collections: ${userCollections.join(', ')}.`);
                    await assignRolesToUser(account, userCollections);
                } else {
                    alert('User does not have any special collections.');
                }

            } catch (err) {
                console.error('Error when checking user ordinals:', err);
                alert('Failed to verify ordinals. Please try again.');
            }
        };

        // Option 1: Using POST
        const assignRolesToUser = async (account, collections) => {
            const roles = collections.map(collection => DISCORD_ROLE_IDS[collection]).filter(role => role);
            console.log("Assigning roles to user:", roles);

            // Convert roles to a comma-separated string
            const rolesString = roles.join(',');
            const url = `https://fantastic-space-couscous-w4q9gr5prrwfjwj-8080.app.github.dev/assign_roles`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account,
                        roles: rolesString,
                    }),
                });

                if (response.ok) {
                    console.log('Roles successfully assigned to user.');
                } else {
                    console.error('Failed to assign roles to user. Response status:', response.status);
                }
            } catch (err) {
                console.error('Error when assigning roles to user:', err);
            }
        };

        // Option 2: Using GET
        /*
        const assignRolesToUser = async (account, collections) => {
            const roles = collections.map(collection => DISCORD_ROLE_IDS[collection]).filter(role => role);
            console.log("Assigning roles to user:", roles);

            // Convert roles to a comma-separated string
            const rolesString = roles.join(',');
            const url = `https://fantastic-space-couscous-w4q9gr5prrwfjwj-8080.app.github.dev/assign_roles?account=${encodeURIComponent(account)}&roles=${encodeURIComponent(rolesString)}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    console.log('Roles successfully assigned to user.');
                } else {
                    console.error('Failed to assign roles to user. Response status:', response.status);
                }
            } catch (err) {
                console.error('Error when assigning roles to user:', err);
            }
        };
        */

        document.getElementById('loginWithWallet').addEventListener('click', loginWithPandaWallet);
    </script>
</body>
</html>
