<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Favicon links -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://your-icon-url.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://your-icon-url.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://your-icon-url.png">
    
    <!-- Meta tags for browser and mobile support -->
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title -->
    <title>1Sat Society</title>
    
    <!-- Font and stylesheet links -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
    
    <style>
        /* CSS variables for theme colors */
        :root {
            --primary-color: #FF9900;
            --secondary-color: #1e1e1e;
            --accent-color: #FF4500;
            --text-color: #FFF;
            --button-bg: #1e1e1e;
            --button-text: #FF9900;
            --button-hover-bg: #333333;
            --button-hover-text: #FFD700;
            --shadow-color: rgba(0, 0, 0, 0.6);
            --glow-color: rgba(255, 153, 0, 0.75);
        }

        /* Basic styling for body */
        body {
            font-family: 'Roboto', sans-serif;
            background: #000;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Styling for the header */
        h1 {
            color: var(--primary-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            font-size: 3rem;
            animation: fadeInDown 1s ease-in-out;
        }

        /* Animation for header fade-in */
        @keyframes fadeInDown {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Styling for the login button */
        #loginWithWallet {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 14px 0 var(--shadow-color);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s, color 0.3s;
            animation: fadeInUp 1s ease-in-out;
        }

        /* Hover effect for the login button */
        #loginWithWallet:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-hover-text);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 var(--shadow-color), 0 0 20px var(--glow-color);
        }

        /* Animation for button fade-in */
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Styling for the container */
        .container {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.85);
            box-shadow: 0 8px 32px 0 var(--shadow-color), 0 0 20px var(--glow-color);
            animation: fadeIn 1.5s ease-in-out;
        }

        /* Animation for container fade-in */
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        /* Styling for social buttons */
        .social-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            animation: fadeInUp 1.5s ease-in-out;
        }

        /* Styling for individual social buttons */
        .social-buttons a {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 50%;
            font-size: 24px;
            transition: background 0.3s, transform 0.2s, color 0.3s;
            box-shadow: 0 4px 14px 0 var(--shadow-color);
        }

        /* Hover effect for social buttons */
        .social-buttons a:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 6px 20px 0 var(--shadow-color), 0 0 20px var(--glow-color);
        }

        .social-buttons i {
            margin: 0;
            line-height: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInModal 2s ease-in-out;
        }

        /* Animation for modal fade-in */
        @keyframes fadeInModal {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        /* Modal content styling */
        .modal-content {
            background: rgba(0, 0, 0, 0.95); /* Slightly transparent background */
            padding: 20px;
            border: 1px solid var(--primary-color); /* Orange border */
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            text-align: left;
            animation: fadeInModalContent 2s ease-in-out;
        }

        /* Animation for modal content fade-in */
        @keyframes fadeInModalContent {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 2rem;
        }

        .modal-content ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .modal-content ul li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .modal-content ul li span {
            flex-grow: 1;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .modal-content p {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        /* Styling for the copy button */
        .copy-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            border-radius: 5px;
            transition: background 0.3s, color 0.3s;
        }

        .copy-btn:hover {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .copy-btn svg {
            margin-right: 5px;
        }

        /* Close button styling for the modal */
        .close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: var(--accent-color);
            text-decoration: none;
        }

        /* Spinner styles for loading indication */
        .spinner {
            display: none;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo image -->
        <img src="https://your-logo-url.png" alt="Logo">
        <!-- Placeholder for username -->
        <h1>{{ username }}</h1>
        <!-- Button to trigger wallet login -->
        <button id="loginWithWallet">Click To Verify</button>
        <!-- Social media links -->
        <div class="social-buttons">
            <a href="https://twitter.com/your-twitter-handle" target="_blank" title="Twitter">
                <!-- SVG icon for Twitter -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L></path>
                </svg>
            </a>
            <a href="https://github.com/your-github-handle" target="_blank" title="GitHub">
                <!-- SVG icon for GitHub -->
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.303 3.438 9.8 8.205 11.387.6.113.82-"></path>
                </svg>
            </a>
        </div>

        <!-- Modal for membership info -->
        <div id="infoModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>How to Become a Member</h2>
                <p>To become a member of the 1Sat Society Discord, please verify your wallet wi></p>
                <ul id="collections-list">
                    <!-- Collections will be populated here by JavaScript -->
                </ul>
                <p>If you experience issues, disconnect and reconnect your wallet. This often r></p>
            </div>
        </div>
    
        <!-- Spinner for loading -->
        <div class="spinner" id="spinner"></div>
    
        <script>
            // Placeholder for the username
            const username = "{{ username }}";
            console.log("Username received for verification:", username);
    
            // Collection IDs
            const COLLECTION_IDS = {
                "Grand Tardinians": "collection_id_1",
                "Order of the Delta": "collection_id_2",
                "0Face": "collection_id_3",
                "Distortion": "collection_id_4",
                "Icarus Corp": "collection_id_5",
                "GM Pepes": "collection_id_6",
                "Dragon Army": "collection_id_7",
                "Pixel Foxes": "collection_id_8",
                "OG Frogs": "collection_id_9",
                "WTF TOKYO": "collection_id_10",
                "Twetch Survivors": "collection_id_11",
                "Based Frogs": "collection_id_12"
            };
    
            // Discord webhook URL
            const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/your-webhook-url";
            console.log("Configured Discord webhook URL for notifications");
    
            // Desired traits for Pixel Foxes collection
            const DESIRED_FOX_BODY_TRAITS = ["Common Cozy", "Uncommon Cozy", "Rare Cozy", "Epic Cozy"];
    
            // Initialize Panda Wallet provider
            const initProvider = () => {
                console.log("Initializing Panda Wallet provider...");
                if (window.panda?.isReady) {
                    console.log("Panda Wallet provider is ready.");
                    return window.panda;
                } else {
                    console.log("Yours Wallet extension not detected.");
                    if (confirm('Yours Wallet extension is not detected. Would you like to install it now?')) {
                        window.open('https://chromewebstore.google.com/detail/yours-wallet/mlbnicld');
                    }
                }
                return null;
            };
        
            // Login with Panda Wallet
            const loginWithPandaWallet = async () => {
                console.log("Attempting to log in with Panda Wallet...");
                const wallet = initProvider();
                if (!wallet) return;
                console.log("Connecting to Panda Wallet...");
                const accounts = await wallet.connect();
                if (accounts.length === 0) {
                    console.log("No accounts found, ensure Yours Wallet is unlocked");
                    alert('No accounts found. Please ensure your Yours Wallet is unlocked.');
                    return;
                }
                const account = accounts[0];
                console.log('Logged in with Account:', account);
                const { bsvAddress, ordAddress } = await wallet.getAddresses();
                console.log('Logged in with BSV Address:', bsvAddress);
                console.log('Logged in with Ordinals Address:', ordAddress);
                await checkUserOrdinals(ordAddress, account, username);
                await sendToServer(username, bsvAddress, ordAddress);
            };

            // Check user ordinals for specific collections
            const checkUserOrdinals = async (ordAddress, account, username) => {
                console.log("Checking user's ordinals for address:", ordAddress);
                const userCollections = new Set();
                const userPixelFoxes = new Set();

                // Check other collections using the original method
                for (const [name, collectionId] of Object.entries(COLLECTION_IDS)) {
                    if (name === "Pixel Foxes") continue; // Skip Pixel Foxes for now

                    try {
                        console.log(`Fetching holders for collection: ${name}, ID: ${collectionId}`);
                        const response = await fetch(`https://ordinals.gorillapool.io/api/collection/${collectionId}/holders`);
                        if (!response.ok) throw new Error(`Failed to fetch holders for collection: ${collectionId}`);
                        const holders = await response.json();
                        console.log(`Fetched ${holders.length} holders for collection: ${name}`);

                        if (holders.some(holder => holder.address === ordAddress)) {
                            userCollections.add(name);
                            console.log(`User has access to collection: ${name}`);
                        } else {
                            console.log(`User does not have access to collection: ${name}`);
                        }
                    } catch (err) {
                        console.error(`Error fetching collection ${name}:`, err);
                    }
                }

                // Check Pixel Foxes collection using the new unspent endpoint
                const fetchAllUnspentTxos = async (ordAddress) => {
                    let allTxos = [];
                    let offset = 0;
                    let fetchMore = true;

                    while (fetchMore) {
                        const response = await fetch(`https://ordinals.gorillapool.io/api/txos/address/${ordAddress}/unspent?offset=${offset}&limit=100`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) throw new Error(`Failed to fetch unspent transactions: ${response.statusText}`);
                        const txos = await response.json();

                        allTxos = allTxos.concat(txos);
                        offset += 100;
                        fetchMore = txos.length === 100; // Continue fetching if we got exactly 100 txos
                    }

                    return allTxos;
                };

                try {
                    const unspentTxos = await fetchAllUnspentTxos(ordAddress);

                    console.log('Unspent transactions:', unspentTxos);

                    unspentTxos.forEach(tx => {
                        const { data } = tx;

                        if (data && data.map) {
                            const { map } = data;
                            const { collectionId, traits } = map.subTypeData || {};

                            // Check if it's a Pixel Fox with the desired body trait
                            if (collectionId === COLLECTION_IDS["Pixel Foxes"] && traits) {
                                const bodyTrait = traits.find(trait => trait.name === "body");
                                if (bodyTrait && DESIRED_FOX_BODY_TRAITS.includes(bodyTrait.value)) {
                                    userPixelFoxes.add(bodyTrait.value);
                                    userCollections.add("Pixel Foxes");
                                }
                            }
                        }
                    });

                    userPixelFoxes.forEach(trait => {
                        console.log(`User has a Pixel Fox with the desired body trait: ${trait}`);
                    });

                    if (userCollections.size > 0) {
                        console.log(`User has access to the following collections: ${Array.from(userCollections)}`);
                        await sendToDiscord(username, account, Array.from(userCollections));
                    } else {
                        console.log('User does not have any special collections.');
                        alert('You do not have access to any 1Sat Society collections. Please disconnect and try again.');
                    }
                } catch (err) {
                    console.error("Error fetching collections:", err);
                }
            };

            // Send user information and collections to Discord
            const sendToDiscord = async (username, account, collections) => {
                console.log("Sending user info and collections to Discord:", username, collections);
                try {
                    const response = await fetch(DISCORD_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            content: ``,
                            embeds: [{
                                title: "Verification Successful",
                                description: `Congrats Fren!!! Username: ${username} has been assigned to collections: ${collections.join(", ")}`,
                                color: 65280
                            }]
                        })
                    });
                    if (!response.ok) {
                        throw new Error("Failed to send to Discord: " + response.statusText);
                    }
                    console.log("User info successfully sent to Discord.");

                    setTimeout(() => {
                        window.location.href = "https://discord.com/channels/your-discord-channel-id";
                    }, 2000);

                } catch (err) {
                    console.error("Error when sending to Discord:", err);
                    alert("Error when sending to Discord. Please try again. Error: " + err.message);
                }
            };

            // Send wallet addresses to the server
            const sendToServer = async (username, bsvAddress, ordAddress) => {
                console.log("Sending wallet addresses to server:", username, bsvAddress, ordAddress);
                try {
                    const response = await fetch('https://your-server.com/save_wallet_addresses', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username, bsvAddress, ordAddress})
                    });
                    const data = await response.json();
                    console.log("Response from server on saving addresses:", data);
                    if (!response.ok) {
                        throw new Error("Failed to save wallet addresses: " + data.message);
                    }
                    alert("Wallet Scan Successful Click Ok To Head Back To Discord.");
                } catch (err) {
                    console.error("Error sending addresses to server:", err);
                    alert("Error when trying to send addresses to server. Please try again. Error: " + err.message);
                }
            };

            // Event listener for login button
            document.getElementById('loginWithWallet').addEventListener('click', async () => {
                const spinner = document.getElementById('spinner');
                spinner.style.display = 'block';
                try {
                    await loginWithPandaWallet();
                } finally {
                    spinner.style.display = 'none';
                }
            });

            // Modal script
            const modal = document.getElementById("infoModal");
            const span = document.getElementsByClassName("close")[0];

            window.onload = () => {
                setTimeout(() => {
                    modal.style.display = "flex";
                    modal.classList.add("fade-in");
                }, 1500); // 1 second delay
                populateCollections();
            }

            span.onclick = () => {
                modal.style.display = "none";
            }

            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            }

            // Populate collections in the modal
            const populateCollections = () => {
                const collectionsList = document.getElementById('collections-list');
                collectionsList.innerHTML = '';
                for (const [name, collectionId] of Object.entries(COLLECTION_IDS)) {
                    const listItem = document.createElement('li');
                    const collectionName = document.createElement('span');
                    collectionName.textContent = name;
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-btn';
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-files" viewBox="0 0 16 16">
                                              <path d="M10 1.5v1a.5.5 0 0 0 .5.5h2A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H12v1a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2a1 1 0 0 1-1-1v-1h-2A1.5 1.5 0 0 0 6 2.5V3H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2-2v-1H5.5A1.5 1.5 0 0 1 4 11.5v-7A1.5 1.5 0 0 1 5.5 3H10zm.5-1h-2a1 1 0 0 1-1-1h3a1 1 0 0 1 1 1v2z"/>
                                              <path d="M9.5 1a1.5 1.5 0 0 1 1.415 1h-3.83A1.5 1.5 0 0 1 9.5 1z"/>
                                            </svg> ${collectionId.substring(0, 6)}...${collectionId.slice(-6)}`;
                    copyButton.onclick = () => {
                        copyToClipboard(collectionId);
                        copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                                                  <path d="M13.485 1.485a.75.75 0 0 1 1.03 1.03l-8 8a.75.75 0 0 1-1.086-.004L1.354 8.354a.75.75 0 0 1 1.086-1.032L5.5 10.293 13.485 1.485z"/>
                                                </svg> Collection ID Copied!`;
                        setTimeout(() => {
                            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-files" viewBox="0 0 16 16">
                                                      <path d="M10 1.5v1a.5.5 0 0 0 .5.5h2A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H12v1a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-2a1 1 0 0 1-1-1v-1h-2A1.5 1.5 0 0 0 6 2.5V3H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2-2v-1H5.5A1.5 1.5 0 0 1 4 11.5v-7A1.5 1.5 0 0 1 5.5 3H10zm.5-1h-2a1 1 0 0 1-1-1h3a1 1 0 0 1 1 1v2z"/>
                                                      <path d="M9.5 1a1.5 1.5 0 0 1 1.415 1h-3.83A1.5 1.5 0 0 1 9.5 1z"/>
                                                    </svg> ${collectionId.substring(0, 6)}...${collectionId.slice(-6)}`;
                        }, 2000);
                    };
                    listItem.appendChild(collectionName);
                    listItem.appendChild(copyButton);
                    collectionsList.appendChild(listItem);
                }
            }

            // Copy text to clipboard
            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Collection ID copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            }
        </script>
    </div>
</body>
</html>
